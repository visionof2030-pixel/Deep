# main.py
from fastapi import FastAPI, HTTPException, Depends, Header, Query
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse, JSONResponse
from pydantic import BaseModel
from pathlib import Path
from datetime import datetime, timedelta
import os
import itertools
import json
import google.generativeai as genai
from typing import Optional, List, Dict, Any

from database import init_db, get_connection
from create_key import create_key
from security import activation_required

# ---------- Init DB ----------
init_db()

# ---------- App ----------
app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ---------- Admin Auth ----------
ADMIN_TOKEN = os.getenv("ADMIN_TOKEN", "")

def admin_auth(x_admin_token: str = Header(...)):
    if x_admin_token != ADMIN_TOKEN:
        raise HTTPException(status_code=401, detail="Unauthorized")

# ---------- Models ----------
class Req(BaseModel):
    prompt: str

class GenerateKeyReq(BaseModel):
    plan: str

class GenerateReportRequest(BaseModel):
    criterion_id: str  # معرف المعيار التربوي
    subcategory_id: str  # معرف التصنيف الفرعي
    report_id: str  # معرف التقرير
    report_data: Dict[str, Any] = {}  # بيانات إضافية (المادة، الصف، إلخ)

# ---------- Plans ----------
PLANS = {
    "5min_1":   {"minutes": 5,    "usage": 1},
    "15min_2":  {"minutes": 15,   "usage": 2},
    "30min_3":  {"minutes": 30,   "usage": 3},
    "1day_6":   {"days": 1,       "usage": 6},
    "3day_15":  {"days": 3,       "usage": 15},
    "7day_25":  {"days": 7,       "usage": 25},
    "1m_45":    {"days": 30,      "usage": 45},
    "2m_65":    {"days": 60,      "usage": 65},
    "3m_120":   {"days": 90,      "usage": 120},
    "5m_200":   {"days": 150,     "usage": 200},
}

# ---------- Gemini Keys ----------
api_keys = [
    os.getenv("GEMINI_API_KEY_1"),
    os.getenv("GEMINI_API_KEY_2"),
    os.getenv("GEMINI_API_KEY_3"),
    os.getenv("GEMINI_API_KEY_4"),
    os.getenv("GEMINI_API_KEY_5"),
    os.getenv("GEMINI_API_KEY_6"),
    os.getenv("GEMINI_API_KEY_7"),
]
api_keys = [k for k in api_keys if k]
key_cycle = itertools.cycle(api_keys) if api_keys else None

def get_api_key():
    if not key_cycle:
        raise HTTPException(status_code=500, detail="No Gemini API key configured")
    return next(key_cycle)

# ============================================================================
# البيانات الجديدة: المعايير التربوية والتصنيفات الفرعية والتقارير
# ============================================================================

# المعايير التربوية (11 معياراً)
CRITERIA = [
    {
        "id": "c1",
        "name": "أداء الواجبات الوظيفية",
        "weight": "10%",
        "order": 1
    },
    {
        "id": "c2",
        "name": "التفاعل مع المجتمع المهني",
        "weight": "10%",
        "order": 2
    },
    {
        "id": "c3",
        "name": "التفاعل مع أولياء الأمور",
        "weight": "10%",
        "order": 3
    },
    {
        "id": "c4",
        "name": "التنويع في استراتيجيات التدريس",
        "weight": "10%",
        "order": 4
    },
    {
        "id": "c5",
        "name": "تحسين نتائج المتعلمين",
        "weight": "10%",
        "order": 5
    },
    {
        "id": "c6",
        "name": "إعداد وتنفيذ خطة التعلم",
        "weight": "10%",
        "order": 6
    },
    {
        "id": "c7",
        "name": "توظيف تقنيات ووسائل التعليم المناسبة",
        "weight": "10%",
        "order": 7
    },
    {
        "id": "c8",
        "name": "تهيئة البيئة التعليمية",
        "weight": "5%",
        "order": 8
    },
    {
        "id": "c9",
        "name": "الإدارة الصفية",
        "weight": "5%",
        "order": 9
    },
    {
        "id": "c10",
        "name": "تحليل نتائج المتعلمين وتشخيص مستوياتهم",
        "weight": "10%",
        "order": 10
    },
    {
        "id": "c11",
        "name": "تنوع أساليب التقويم",
        "weight": "10%",
        "order": 11
    }
]

# التصنيفات الفرعية والمعايير المرتبطة بها
SUBCATEGORIES = [
    # c1: أداء الواجبات الوظيفية
    {"id": "c1_s1", "criterion_id": "c1", "name": "يطبق الأنظمة وقواعد السلوك الوظيفية وأخلاقيات بيئة التعلم", "order": 1},
    {"id": "c1_s2", "criterion_id": "c1", "name": "حماية البيانات والمعلومات التي تتعلق بالعمل أو الأنشطة المهنية من الوصول غير المصرح به", "order": 2},
    {"id": "c1_s3", "criterion_id": "c1", "name": "التعاون مع المؤسسات الحكومية في المبادرات الوطنية", "order": 3},
    {"id": "c1_s4", "criterion_id": "c1", "name": "تنظيم أنشطة توعوية حول أهمية الانتماء الوطني", "order": 4},
    {"id": "c1_s5", "criterion_id": "c1", "name": "تنظيم أنشطة توعوية حول أهمية الانتماء (المدرسي والمجتمعي)", "order": 5},
    {"id": "c1_s6", "criterion_id": "c1", "name": "الامتثال للقوانين واللوائح وسياسات وإجراءات العمل", "order": 6},
    
    # c2: التفاعل مع المجتمع المهني
    {"id": "c2_s1", "criterion_id": "c2", "name": "حضور المؤتمرات والندوات التعليمية", "order": 1},
    {"id": "c2_s2", "criterion_id": "c2", "name": "المشاركة في ورش العمل التدريبية لتحسين المهارات التعليمية", "order": 2},
    {"id": "c2_s3", "criterion_id": "c2", "name": "الالتحاق ببرامج تدريبية لتعلم أساليب تدريس حديثة", "order": 3},
    {"id": "c2_s4", "criterion_id": "c2", "name": "الحصول على شهادات مهنية معتمدة في مجال التعليم", "order": 4},
    {"id": "c2_s5", "criterion_id": "c2", "name": "إطلاق مبادرات تعليمية لتحسين جودة التعليم", "order": 5},
    {"id": "c2_s6", "criterion_id": "c2", "name": "تقديم استشارات تربوية للمعلمين الجدد", "order": 6},
    {"id": "c2_s7", "criterion_id": "c2", "name": "تبادل الخبرات مع المعلمين في نفس التخصص أو تخصصات أخرى", "order": 7},
    {"id": "c2_s8", "criterion_id": "c2", "name": "التفكير الذاتي لتحسين الممارسات وبناء بيئة تعليمية تعزز التعلم المستمر", "order": 8},
    
    # c3: التفاعل مع أولياء الأمور
    {"id": "c3_s1", "criterion_id": "c3", "name": "تنظيم اجتماعات دورية مع أولياء الأمور لمناقشة تقدم الطلاب", "order": 1},
    {"id": "c3_s2", "criterion_id": "c3", "name": "إرسال تقارير منتظمة عن أداء الطلاب أكاديمياً وسلوكياً", "order": 2},
    {"id": "c3_s3", "criterion_id": "c3", "name": "استخدام وسائل التواصل الحديثة لإبقاء أولياء الأمور على اطلاع", "order": 3},
    {"id": "c3_s4", "criterion_id": "c3", "name": "الاستجابة والاستماع لملاحظات ومخاوف أولياء الأمور", "order": 4},
    {"id": "c3_s5", "criterion_id": "c3", "name": "تشجيع أولياء الأمور بالمشاركة في العملية التعليمية", "order": 5},
    
    # c4: التنويع في استراتيجيات التدريس
    {"id": "c4_s1", "criterion_id": "c4", "name": "استخدام التعلم النشط مثل المناقشات الجماعية والعروض التقديمية", "order": 1},
    {"id": "c4_s2", "criterion_id": "c4", "name": "تطبيق التعلم القائم على المشاريع لتعزيز الإبداع وحل المشكلات", "order": 2},
    {"id": "c4_s3", "criterion_id": "c4", "name": "استخدام استراتيجيات تنمية التفكير (التفكير الناقد، الإبداعي، العصف الذهني)", "order": 3},
    {"id": "c4_s4", "criterion_id": "c4", "name": "استخدام الوسائل البصرية والسمعية مثل الفيديوهات والصور", "order": 4},
    {"id": "c4_s5", "criterion_id": "c4", "name": "تطبيق استراتيجيات التعليم المتمايز لتناسب أنماط التعلم المختلفة", "order": 5},
    {"id": "c4_s6", "criterion_id": "c4", "name": "تطبيق استراتيجيات التعلم الحديثة (الصف المقلوب، الألعاب الإلكترونية، الرحلات المعرفية)", "order": 6},
    {"id": "c4_s7", "criterion_id": "c4", "name": "تطبيق التعلم التعاوني واستراتيجيات العمل الجماعي", "order": 7},
    
    # c5: تحسين نتائج المتعلمين
    {"id": "c5_s1", "criterion_id": "c5", "name": "تحديد أهداف ومعايير واضحة ليعرف المتعلمون ما يتوقع منهم تحقيقه", "order": 1},
    {"id": "c5_s2", "criterion_id": "c5", "name": "تقديم إفادة سريعة ومحددة فور ملاحظة الأداء", "order": 2},
    {"id": "c5_s3", "criterion_id": "c5", "name": "تكييف الإفادة وفق الاحتياجات الفردية للطلاب", "order": 3},
    {"id": "c5_s4", "criterion_id": "c5", "name": "تعزيز الثقة وتشجيع التطور من خلال ملاحظات تشجيعية", "order": 4},
    {"id": "c5_s5", "criterion_id": "c5", "name": "استخدام التكنولوجيا لتقديم الإفادة بطرق مبتكرة", "order": 5},
    
    # c6: إعداد وتنفيذ خطة التعلم
    {"id": "c6_s1", "criterion_id": "c6", "name": "وضع أهداف تعليمية واضحة وقابلة للقياس", "order": 1},
    {"id": "c6_s2", "criterion_id": "c6", "name": "تصميم خطة دراسية تتوافق مع المنهج الدراسي واحتياجات الطلاب", "order": 2},
    {"id": "c6_s3", "criterion_id": "c6", "name": "مراجعة الخطط بشكل دوري وتعديلها بناءً على نتائج الطلاب", "order": 3},
    {"id": "c6_s4", "criterion_id": "c6", "name": "مشاركة الخطط مع الزملاء للحصول على ملاحظات وتحسينها", "order": 4},
    {"id": "c6_s5", "criterion_id": "c6", "name": "تفهم الخصائص النفسية للمرحلة العمرية التي يقوم بتدريسها", "order": 5},
    
    # c7: توظيف تقنيات ووسائل التعليم المناسبة
    {"id": "c7_s1", "criterion_id": "c7", "name": "استخدام السبورات الذكية والأجهزة اللوحية في التدريس", "order": 1},
    {"id": "c7_s2", "criterion_id": "c7", "name": "تطبيق برامج التعلم الالكتروني مثل منصات التعليم عن بعد", "order": 2},
    {"id": "c7_s3", "criterion_id": "c7", "name": "تشجيع الطلاب على استخدام التطبيقات التعليمية لتعزيز التعلم الذاتي", "order": 3},
    {"id": "c7_s4", "criterion_id": "c7", "name": "تنظيم ورش العمل حول استخدام التكنولوجيا في التعليم", "order": 4},
    
    # c8: تهيئة البيئة التعليمية
    {"id": "c8_s1", "criterion_id": "c8", "name": "تزيين الفصل بوسائل تعليمية جذابة", "order": 1},
    {"id": "c8_s2", "criterion_id": "c8", "name": "تنظيم الفصل بشكل يسهل الحركة والتفاعل", "order": 2},
    {"id": "c8_s3", "criterion_id": "c8", "name": "توفير الأدوات والموارد التعليمية اللازمة", "order": 3},
    {"id": "c8_s4", "criterion_id": "c8", "name": "توفير بيئة تعليمية آمنة وخالية من الأخطار المادية", "order": 4},
    {"id": "c8_s5", "criterion_id": "c8", "name": "تمكين المتعلمين من التعبير عن أنفسهم ومشاركة أفكارهم", "order": 5},
    {"id": "c8_s6", "criterion_id": "c8", "name": "إثارة دافعية المتعلمين من خلال التنوع في أساليب التعلم", "order": 6},
    
    # c9: الإدارة الصفية
    {"id": "c9_s1", "criterion_id": "c9", "name": "وضع قواعد واضحة للسلوك في الصف", "order": 1},
    {"id": "c9_s2", "criterion_id": "c9", "name": "استخدام أساليب تحفيزية لتشجيع الطلاب على الالتزام", "order": 2},
    {"id": "c9_s3", "criterion_id": "c9", "name": "التعامل مع المشكلات السلوكية بشكل عادل وحازم", "order": 3},
    {"id": "c9_s4", "criterion_id": "c9", "name": "تنظيم الوقت بشكل فعال خلال الحصة", "order": 4},
    
    # c10: تحليل نتائج المتعلمين وتشخيص مستوياتهم
    {"id": "c10_s1", "criterion_id": "c10", "name": "استخدام اختبارات تقييمية دورية لقياس تقدم الطلاب", "order": 1},
    {"id": "c10_s2", "criterion_id": "c10", "name": "تحليل النتائج لتحديد نقاط القوة والضعف", "order": 2},
    {"id": "c10_s3", "criterion_id": "c10", "name": "توفير تغذية راجعة فردية للطلاب", "order": 3},
    {"id": "c10_s4", "criterion_id": "c10", "name": "تطبيق خطط علاجية للطلاب الذين يحتاجون إلى دعم", "order": 4},
    {"id": "c10_s5", "criterion_id": "c10", "name": "قياس التطبيق العملي للمعرفة عبر مواقف ومشاريع حقيقية", "order": 5},
    
    # c11: تنوع أساليب التقويم
    {"id": "c11_s1", "criterion_id": "c11", "name": "استخدام الاختبارات الكتابية والشفوية", "order": 1},
    {"id": "c11_s2", "criterion_id": "c11", "name": "تطبيق التقييم العملي من خلال المشاريع والعروض", "order": 2},
    {"id": "c11_s3", "criterion_id": "c11", "name": "استخدام التقييم التكويني لتتبع تقدم الطلاب", "order": 3},
    {"id": "c11_s4", "criterion_id": "c11", "name": "استخدام التقويم القبلي للوقوف على مدى استعداد المتعلمين", "order": 4},
    {"id": "c11_s5", "criterion_id": "c11", "name": "تطبيق التقويم الختامي لمعرفة مدى تحقق الأهداف", "order": 5}
]

# التقارير المرتبطة بالتصنيفات الفرعية (10 تقارير لكل تصنيف فرعي)
REPORTS = [
    # c1_s1: يطبق الأنظمة وقواعد السلوك الوظيفية
    {"id": "r_c1_s1_1", "subcategory_id": "c1_s1", "name": "تقرير عن التزامي بارتداء الزي الوطني السعودي يومياً خلال الدوام الرسمي", "order": 1},
    {"id": "r_c1_s1_2", "subcategory_id": "c1_s1", "name": "توثيق لمهام الإشراف اليومي على الطابور الصباحي ومتابعة اصطفاف الطلاب", "order": 2},
    {"id": "r_c1_s1_3", "subcategory_id": "c1_s1", "name": "تقرير عن الإشراف على الفسحة المدرسية ومتابعة سلوك الطلاب وتوجيههم", "order": 3},
    {"id": "r_c1_s1_4", "subcategory_id": "c1_s1", "name": "توثيق جدول المناوبة نهاية اليوم الدراسي والإشراف على خروج الطلاب", "order": 4},
    {"id": "r_c1_s1_5", "subcategory_id": "c1_s1", "name": "تقرير عن الالتزام بالحضور قبل بداية الطابور الصباحي بخمس عشرة دقيقة", "order": 5},
    {"id": "r_c1_s1_6", "subcategory_id": "c1_s1", "name": "توثيق لتفعيل لائحة السلوك والمواظبة مع طالب كثير الغياب ومتابعته", "order": 6},
    {"id": "r_c1_s1_7", "subcategory_id": "c1_s1", "name": "تقرير عن الالتزام بالجدول الدراسي وعدم مغادرة الفصل أثناء الحصة", "order": 7},
    {"id": "r_c1_s1_8", "subcategory_id": "c1_s1", "name": "توثيق للمشاركة الفاعلة في اجتماعات مجلس المعلمين الأسبوعية", "order": 8},
    {"id": "r_c1_s1_9", "subcategory_id": "c1_s1", "name": "تقرير عن تطبيق تعليمات الاختبارات وعدم السماح بالغش داخل القاعة", "order": 9},
    {"id": "r_c1_s1_10", "subcategory_id": "c1_s1", "name": "توثيق للالتزام بتعبئة سجل متابعة الطلاب وتوثيق الملاحظات اليومية", "order": 10},
    
    # c1_s2: حماية البيانات والمعلومات
    {"id": "r_c1_s2_1", "subcategory_id": "c1_s2", "name": "تقرير عن تسليم كشوف الدرجات النهائية للإدارة في مظاريف مغلقة", "order": 1},
    {"id": "r_c1_s2_2", "subcategory_id": "c1_s2", "name": "توثيق لحفظ سجلات متابعة الطلاب في ملفات داخل خزانة مغلقة بالفصل", "order": 2},
    {"id": "r_c1_s2_3", "subcategory_id": "c1_s2", "name": "تقرير عن الالتزام بعدم تصوير أوراق الأسئلة أو نماذج الإجابة ونشرها", "order": 3},
    {"id": "r_c1_s2_4", "subcategory_id": "c1_s2", "name": "توثيق لاستخدام نظام نور بشكل آمن وتأمين كلمة المرور وعدم مشاركتها", "order": 4},
    {"id": "r_c1_s2_5", "subcategory_id": "c1_s2", "name": "تقرير عن إتلاف أوراق الاختبارات بعد انتهاء العام الدراسي بطريقة آمنة", "order": 5},
    {"id": "r_c1_s2_6", "subcategory_id": "c1_s2", "name": "توثيق لعدم مشاركة صور الطلاب أو نتائجهم على وسائل التواصل الاجتماعي", "order": 6},
    {"id": "r_c1_s2_7", "subcategory_id": "c1_s2", "name": "تقرير عن حفظ تقارير الطلاب ذوي المشكلات السلوكية في ملفات سرية", "order": 7},
    {"id": "r_c1_s2_8", "subcategory_id": "c1_s2", "name": "توثيق للتأكد من تسجيل الخروج من منصة مدرستي بعد الانتهاء من العمل", "order": 8},
    {"id": "r_c1_s2_9", "subcategory_id": "c1_s2", "name": "تقرير عن عدم ترك أوراق الدرجات أو كشوف الرصد على المكتب أمام الزوار", "order": 9},
    {"id": "r_c1_s2_10", "subcategory_id": "c1_s2", "name": "توثيق للتعامل مع سجلات الطلاب المحولة من التوجيه الطلابي بسرية تامة", "order": 10},
    
    # c1_s3: التعاون مع المؤسسات الحكومية في المبادرات الوطنية
    {"id": "r_c1_s3_1", "subcategory_id": "c1_s3", "name": "تقرير عن المشاركة في تفعيل فعاليات اليوم الوطني السعودي بالمدرسة", "order": 1},
    {"id": "r_c1_s3_2", "subcategory_id": "c1_s3", "name": "توثيق لتفعيل برنامج رفق للإرشاد الطلابي بالتعاون مع وحدة الخدمات", "order": 2},
    {"id": "r_c1_s3_3", "subcategory_id": "c1_s3", "name": "تقرير عن تنظيم محاضرة توعوية عن أضرار التدخين مع مكافحة التدخين", "order": 3},
    {"id": "r_c1_s3_4", "subcategory_id": "c1_s3", "name": "توثيق لمشاركة المدرسة في حملة التبرع بالدم بالتعاون مع مستشفى المنطقة", "order": 4},
    {"id": "r_c1_s3_5", "subcategory_id": "c1_s3", "name": "تقرير عن استضافة الدفاع المدني لتدريب الطلاب على خطط الإخلاء", "order": 5},
    {"id": "r_c1_s3_6", "subcategory_id": "c1_s3", "name": "توثيق لمشاركتي في مبادرة السعودية الخضراء بزراعة شتلات في المدرسة", "order": 6},
    {"id": "r_c1_s3_7", "subcategory_id": "c1_s3", "name": "تقرير عن تفعيل برنامج فطن لتنمية المهارات الشخصية والاجتماعية", "order": 7},
    {"id": "r_c1_s3_8", "subcategory_id": "c1_s3", "name": "توثيق لتنظيم رحلة لطلاب الثانوي لزيارة معرض أمننا بمناسبة اليوم العالمي", "order": 8},
    {"id": "r_c1_s3_9", "subcategory_id": "c1_s3", "name": "تقرير عن المشاركة في حملة التوعية المرورية مع المرور السعودي", "order": 9},
    {"id": "r_c1_s3_10", "subcategory_id": "c1_s3", "name": "توثيق للتعاون مع هيئة الأمر بالمعروف في برامج الأمن الفكري", "order": 10},
    
    # c1_s4: تنظيم أنشطة توعوية حول أهمية الانتماء الوطني
    {"id": "r_c1_s4_1", "subcategory_id": "c1_s4", "name": "تقرير عن تفعيل الإذاعة المدرسية بكلمات عن حب الوطن في الطابور الصباحي", "order": 1},
    {"id": "r_c1_s4_2", "subcategory_id": "c1_s4", "name": "توثيق مسابقة فنية (رسم وتلوين) لطلاب الابتدائي عن معالم المملكة", "order": 2},
    {"id": "r_c1_s4_3", "subcategory_id": "c1_s4", "name": "تقرير عن تنظيم ندوة قصيرة لطلاب المتوسط عن رؤية 2030 وإنجازات الوطن", "order": 3},
    {"id": "r_c1_s4_4", "subcategory_id": "c1_s4", "name": "توثيق المشاركة في احتفالات المدرسة بيوم التأسيس", "order": 4},
    {"id": "r_c1_s4_5", "subcategory_id": "c1_s4", "name": "تقرير عن إعداد مجلة حائطية عن أئمة وملوك المملكة وإنجازاتهم", "order": 5},
    {"id": "r_c1_s4_6", "subcategory_id": "c1_s4", "name": "توثيق فعالية الزي الوطني بتشجيع الطلاب على ارتداء الزي السعودي", "order": 6},
    {"id": "r_c1_s4_7", "subcategory_id": "c1_s4", "name": "تقرير عن تنظيم مسابقة شعرية عن الوطنية لطلاب المرحلة الثانوية", "order": 7},
    {"id": "r_c1_s4_8", "subcategory_id": "c1_s4", "name": "توثيق لتنظيم رحلة مدرسية لزيارة متحف وطني أو معلم تاريخي", "order": 8},
    {"id": "r_c1_s4_9", "subcategory_id": "c1_s4", "name": "تقرير عن تخصيص حصة النشاط للحديث عن المناسبات الوطنية", "order": 9},
    {"id": "r_c1_s4_10", "subcategory_id": "c1_s4", "name": "توثيق لمشاركة الطلاب في ترديد النشيد الوطني بانضباط في الطابور", "order": 10},
    
    # c1_s5: تنظيم أنشطة توعوية حول أهمية الانتماء (المدرسي والمجتمعي)
    {"id": "r_c1_s5_1", "subcategory_id": "c1_s5", "name": "تقرير عن حث الطلاب على الحفاظ على نظافة المدرسة وفصولهم", "order": 1},
    {"id": "r_c1_s5_2", "subcategory_id": "c1_s5", "name": "توثيق فعالية أنا ساعد مدرستي لتجميل ساحة المدرسة", "order": 2},
    {"id": "r_c1_s5_3", "subcategory_id": "c1_s5", "name": "تقرير عن تنظيم برنامج ترحيب بالطلاب المستجدين في الصف الأول الابتدائي", "order": 3},
    {"id": "r_c1_s5_4", "subcategory_id": "c1_s5", "name": "توثيق مسابقة أفضل فصل لتعزيز روح الانتماء للمكان", "order": 4},
    {"id": "r_c1_s5_5", "subcategory_id": "c1_s5", "name": "تقرير عن تخصيص حصة للحديث عن تاريخ المدرسة وإنجازاتها السابقة", "order": 5},
    {"id": "r_c1_s5_6", "subcategory_id": "c1_s5", "name": "توثيق مشاركة الطلاب في الإذاعة المدرسية لتعزيز ثقتهم وانتمائهم", "order": 6},
    {"id": "r_c1_s5_7", "subcategory_id": "c1_s5", "name": "تقرير عن تنظيم حملة توعوية عن احترام المعلم والعاملين في المدرسة", "order": 7},
    {"id": "r_c1_s5_8", "subcategory_id": "c1_s5", "name": "توثيق فعالية تعزيز الهوية من خلال الأزياء الشعبية في المناسبات", "order": 8},
    {"id": "r_c1_s5_9", "subcategory_id": "c1_s5", "name": "تقرير عن تشجيع الطلاب على المشاركة في أعمال تطوعية لخدمة الحي", "order": 9},
    {"id": "r_c1_s5_10", "subcategory_id": "c1_s5", "name": "توثيق لبرنامج توجيهي عن أهمية احترام ممتلكات المدرسة العامة", "order": 10},
    
    # c1_s6: الامتثال للقوانين واللوائح
    {"id": "r_c1_s6_1", "subcategory_id": "c1_s6", "name": "تقرير عن تطبيق سياسة منع الغش في الاختبارات كما هو منصوص عليه", "order": 1},
    {"id": "r_c1_s6_2", "subcategory_id": "c1_s6", "name": "توثيق للإجراءات المتبعة أثناء مناوبة نهاية اليوم لضمان سلامة الخروج", "order": 2},
    {"id": "r_c1_s6_3", "subcategory_id": "c1_s6", "name": "تقرير عن تطبيق خطة الإخلاء في حالات الطوارئ والتدريب عليها مع الطلاب", "order": 3},
    {"id": "r_c1_s6_4", "subcategory_id": "c1_s6", "name": "توثيق للالتزام بسياسة استقبال أولياء الأمور في الأوقات المخصصة فقط", "order": 4},
    {"id": "r_c1_s6_5", "subcategory_id": "c1_s6", "name": "تقرير عن تطبيق لائحة تقويم الطالب في رصد درجات المرحلة الابتدائية", "order": 5},
    {"id": "r_c1_s6_6", "subcategory_id": "c1_s6", "name": "توثيق للامتثال لإجراءات التعامل مع الطلاب ذوي الإعاقة داخل الفصل", "order": 6},
    {"id": "r_c1_s6_7", "subcategory_id": "c1_s6", "name": "تقرير عن تطبيق إجراءات السلامة في معمل الحاسب ومختبرات العلوم", "order": 7},
    {"id": "r_c1_s6_8", "subcategory_id": "c1_s6", "name": "توثيق للالتزام بسياسة الإجازات المرضية وتقديم التقارير الرسمية", "order": 8},
    {"id": "r_c1_s6_9", "subcategory_id": "c1_s6", "name": "تقرير عن تطبيق تعليمات الاختبارات وعدم مغادرة قاعة الاختبار", "order": 9},
    {"id": "r_c1_s6_10", "subcategory_id": "c1_s6", "name": "توثيق للالتزام بإجراءات تسليم المقررات الدراسية في بداية العام", "order": 10},
    
    # c2_s1: حضور المؤتمرات والندوات التعليمية
    {"id": "r_c2_s1_1", "subcategory_id": "c2_s1", "name": "شهادة حضور لندوة التعليم في العصر الرقمي التي أقامتها إدارة التعليم", "order": 1},
    {"id": "r_c2_s1_2", "subcategory_id": "c2_s1", "name": "تقرير عن مشاركتي في المؤتمر الافتراضي تطوير مهارات المعلمين", "order": 2},
    {"id": "r_c2_s1_3", "subcategory_id": "c2_s1", "name": "حضور ندوة استراتيجيات التعامل مع المراهقين في مركز التدريب التربوي", "order": 3},
    {"id": "r_c2_s1_4", "subcategory_id": "c2_s1", "name": "تقرير عن استفادتي من ندوة التقييم من أجل التعلم وتطبيق أفكارها", "order": 4},
    {"id": "r_c2_s1_5", "subcategory_id": "c2_s1", "name": "شهادة حضور المؤتمر السنوي الأول للمدرسة", "order": 5},
    {"id": "r_c2_s1_6", "subcategory_id": "c2_s1", "name": "تقرير عن مشاركتي في ندوة تعريفية عن مناهج المرحلة المتوسطة المطورة", "order": 6},
    {"id": "r_c2_s1_7", "subcategory_id": "c2_s1", "name": "حضور فعاليات اليوم العالمي للمعلم على مستوى الحي", "order": 7},
    {"id": "r_c2_s1_8", "subcategory_id": "c2_s1", "name": "تقرير عن حضور ندوة عبر الإنترنت حول الذكاء العاطفي للمعلم", "order": 8},
    {"id": "r_c2_s1_9", "subcategory_id": "c2_s1", "name": "شهادة حضور مؤتمر الصحة النفسية للطلاب في الجامعة", "order": 9},
    {"id": "r_c2_s1_10", "subcategory_id": "c2_s1", "name": "تقرير عن المشاركة في ندوة المواطنة الرقمية المقدمة من وزارة التعليم", "order": 10},
    
    # c2_s2: المشاركة في ورش العمل التدريبية
    {"id": "r_c2_s2_1", "subcategory_id": "c2_s2", "name": "شهادة حضور ورشة عمل صناعة الوسائل التعليمية من الخامات البيئية", "order": 1},
    {"id": "r_c2_s2_2", "subcategory_id": "c2_s2", "name": "تقرير عن مشاركتي في ورشة إدارة الصف بفاعلية", "order": 2},
    {"id": "r_c2_s2_3", "subcategory_id": "c2_s2", "name": "حضور ورشة عمل تصميم الاختبارات الإلكترونية على منصة مدرستي", "order": 3},
    {"id": "r_c2_s2_4", "subcategory_id": "c2_s2", "name": "تقرير عن ورشة تنمية مهارات التفكير الناقد عند الطلاب", "order": 4},
    {"id": "r_c2_s2_5", "subcategory_id": "c2_s2", "name": "شهادة حضور ورشة عمل مهارات التعامل مع صعوبات التعلم", "order": 5},
    {"id": "r_c2_s2_6", "subcategory_id": "c2_s2", "name": "تقرير عن تطبيقي لاستراتيجيات تعلمتها من ورشة التعلم باللعب مع طلاب الابتدائي", "order": 6},
    {"id": "r_c2_s2_7", "subcategory_id": "c2_s2", "name": "حضور ورشة عمل إعداد خطط علاجية للطلاب المتعثرين", "order": 7},
    {"id": "r_c2_s2_8", "subcategory_id": "c2_s2", "name": "تقرير عن ورشة فن الإلقاء والعرض التقديمي للمعلم", "order": 8},
    {"id": "r_c2_s2_9", "subcategory_id": "c2_s2", "name": "شهادة حضور ورشة أمن المعلومات في المنظومة التعليمية", "order": 9},
    {"id": "r_c2_s2_10", "subcategory_id": "c2_s2", "name": "حضور ورشة أنشطة تقوية لغتي لمعلمي الصفوف الأولية", "order": 10},
    
    # c2_s3: الالتحاق ببرامج تدريبية لتعلم أساليب تدريس حديثة
    {"id": "r_c2_s3_1", "subcategory_id": "c2_s3", "name": "شهادة اجتياز برنامج التعلم القائم على المشروعات عبر منصة دروب", "order": 1},
    {"id": "r_c2_s3_2", "subcategory_id": "c2_s3", "name": "تقرير عن إكمال دورة استراتيجيات التعلم النشط في أكاديمية المعلم", "order": 2},
    {"id": "r_c2_s3_3", "subcategory_id": "c2_s3", "name": "شهادة حضور برنامج تدريبي عن تطبيقات الذكاء الاصطناعي في التعليم", "order": 3},
    {"id": "r_c2_s3_4", "subcategory_id": "c2_s3", "name": "تقرير عن التحاقي ببرنامج التقويم البديل (ملف الإنجاز) عبر التدريب عن بعد", "order": 4},
    {"id": "r_c2_s3_5", "subcategory_id": "c2_s3", "name": "شهادة اجتياز برنامج الصف المقلوب وأثره في التحصيل الدراسي", "order": 5},
    {"id": "r_c2_s3_6", "subcategory_id": "c2_s3", "name": "تقرير عن تطبيقي لأسلوب التلعيب في التدريس بعد حضوري دورة متخصصة", "order": 6},
    {"id": "r_c2_s3_7", "subcategory_id": "c2_s3", "name": "شهادة حضور برنامج الوعي الصوتي لمعلمي الصفوف الأولية", "order": 7},
    {"id": "r_c2_s3_8", "subcategory_id": "c2_s3", "name": "تقرير عن دورة المهارات القيادية للمعلم داخل الفصل", "order": 8},
    {"id": "r_c2_s3_9", "subcategory_id": "c2_s3", "name": "شهادة برنامج تدريبي عن أنماط التعلم (VARK) وكيفية مراعاتها", "order": 9},
    {"id": "r_c2_s3_10", "subcategory_id": "c2_s3", "name": "تقرير عن الاستفادة من برنامج التصحيح اللغوي لتحسين لغتي العربية", "order": 10},
    
    # c2_s4: الحصول على شهادات مهنية معتمدة
    {"id": "r_c2_s4_1", "subcategory_id": "c2_s4", "name": "شهادة (IC3) في أساسيات الحاسب الآلي وتطبيقاته", "order": 1},
    {"id": "r_c2_s4_2", "subcategory_id": "c2_s4", "name": "شهادة (EF SET) أو (IELTS) لمستوى اللغة الإنجليزية", "order": 2},
    {"id": "r_c2_s4_3", "subcategory_id": "c2_s4", "name": "شهادة معتمدة في تأهيل معلمي اللغة العربية للناطقين بغيرها", "order": 3},
    {"id": "r_c2_s4_4", "subcategory_id": "c2_s4", "name": "تقرير عن الحصول على شهادة المعلم الخبير من إحدى المؤسسات التدريبية", "order": 4},
    {"id": "r_c2_s4_5", "subcategory_id": "c2_s4", "name": "شهادة في إدارة الصفوف الافتراضية من منصة مدرستي", "order": 5},
    {"id": "r_c2_s4_6", "subcategory_id": "c2_s4", "name": "شهادة أساسيات التوجيه المهني والإرشاد الطلابي", "order": 6},
    {"id": "r_c2_s4_7", "subcategory_id": "c2_s4", "name": "شهادة دبلومة التأهيل التربوي من إحدى الكليات", "order": 7},
    {"id": "r_c2_s4_8", "subcategory_id": "c2_s4", "name": "شهادة معتمدة في صعوبات التعلم النمائية", "order": 8},
    {"id": "r_c2_s4_9", "subcategory_id": "c2_s4", "name": "شهادة تصميم وإنتاج المحتوى الرقمي التفاعلي", "order": 9},
    {"id": "r_c2_s4_10", "subcategory_id": "c2_s4", "name": "شهادة اجتياز اختبار الرخصة المهنية", "order": 10},
    
    # c2_s5: إطلاق مبادرات تعليمية
    {"id": "r_c2_s5_1", "subcategory_id": "c2_s5", "name": "تقرير عن إطلاق مبادرة قارئ الشهر لتشجيع القراءة الحرة بين الطلاب", "order": 1},
    {"id": "r_c2_s5_2", "subcategory_id": "c2_s5", "name": "توثيق مبادرة مصححون صغار لتصحيح أخطاء بعضهم البعض في الإملاء", "order": 2},
    {"id": "r_c2_s5_3", "subcategory_id": "c2_s5", "name": "تقرير عن مبادرتي رياضيات بالعربي لترجمة المصطلحات الصعبة", "order": 3},
    {"id": "r_c2_s5_4", "subcategory_id": "c2_s5", "name": "توثيق مبادرة منصة للتفوق لمشاركة ملخصات الدروس للطلاب المتغيبين", "order": 4},
    {"id": "r_c2_s5_5", "subcategory_id": "c2_s5", "name": "تقرير عن مبادرة فصل بلا غياب بالتعاون مع طلاب الصف", "order": 5},
    {"id": "r_c2_s5_6", "subcategory_id": "c2_s5", "name": "توثيق مبادرة لغتي هويتي لتحسين الخط العربي", "order": 6},
    {"id": "r_c2_s5_7", "subcategory_id": "c2_s5", "name": "تقرير عن إطلاق مبادرة سفراء الأمن لتعزيز السلامة في المختبرات", "order": 7},
    {"id": "r_c2_s5_8", "subcategory_id": "c2_s5", "name": "توثيق مبادرة المرشد الصغير لمساعدة الطلاب الجدد على الاندماج", "order": 8},
    {"id": "r_c2_s5_9", "subcategory_id": "c2_s5", "name": "تقرير عن مبادرة ورشة إبداع لطلاب الموهوبين داخل الفصل", "order": 9},
    {"id": "r_c2_s5_10", "subcategory_id": "c2_s5", "name": "توثيق مبادرة الاختبارات التشاركية حيث يضع الطلاب أسئلة لبعضهم", "order": 10},
    
    # c2_s6: تقديم استشارات تربوية للمعلمين الجدد
    {"id": "r_c2_s6_1", "subcategory_id": "c2_s6", "name": "تقرير عن لقاء تعريفي للمعلمين الجدد بسياسة المدرسة ونظام التعامل مع الطلاب", "order": 1},
    {"id": "r_c2_s6_2", "subcategory_id": "c2_s6", "name": "توثيق لاجتماعي مع معلم جديد لمساعدته في إعداد خطة تحضير أسبوعية", "order": 2},
    {"id": "r_c2_s6_3", "subcategory_id": "c2_s6", "name": "تقرير عن مشاركتي خبرتي في كيفية إدارة وقت الحصة مع معلم حديث", "order": 3},
    {"id": "r_c2_s6_4", "subcategory_id": "c2_s6", "name": "توثيق لمساعدة معلم جديد في استخدام منصة مدرستي لرفع الدرجات", "order": 4},
    {"id": "r_c2_s6_5", "subcategory_id": "c2_s6", "name": "تقرير عن توجيه معلم جديد في كيفية التعامل مع ولي أمر غاضب", "order": 5},
    {"id": "r_c2_s6_6", "subcategory_id": "c2_s6", "name": "توثيق لحضوري حصة لمعلم جديد وتقديم تغذية راجعة بناءة له", "order": 6},
    {"id": "r_c2_s6_7", "subcategory_id": "c2_s6", "name": "تقرير عن إرشاد معلم جديد لطرق تشجيع الطلاب الخجولين على المشاركة", "order": 7},
    {"id": "r_c2_s6_8", "subcategory_id": "c2_s6", "name": "توثيق لشرح آلية التعامل مع الطلاب ذوي فرط الحركة لمعلم مستجد", "order": 8},
    {"id": "r_c2_s6_9", "subcategory_id": "c2_s6", "name": "تقرير عن لقاء غير رسمي (مجلس معلمين) لتبادل الخبرات مع الزملاء الجدد", "order": 9},
    {"id": "r_c2_s6_10", "subcategory_id": "c2_s6", "name": "توثيق مساهمتي في إعداد دليل إرشادي للمعلم الجديد في المدرسة", "order": 10},
    
    # c2_s7: تبادل الخبرات مع المعلمين
    {"id": "r_c2_s7_1", "subcategory_id": "c2_s7", "name": "تقرير عن اجتماع فريق المواد الاجتماعية لمناقشة خطة تدريس موحدة", "order": 1},
    {"id": "r_c2_s7_2", "subcategory_id": "c2_s7", "name": "توثيق لتبادل نماذج أسئلة اختبارات مع معلم في مدرسة أخرى", "order": 2},
    {"id": "r_c2_s7_3", "subcategory_id": "c2_s7", "name": "تقرير عن مشاركتي استراتيجية ناجحة في تدريس النحو مع زملاء اللغة العربية", "order": 3},
    {"id": "r_c2_s7_4", "subcategory_id": "c2_s7", "name": "توثيق لقاء مع معلم تربية فنية لتصميم وسيلة تعليمية مشتركة", "order": 4},
    {"id": "r_c2_s7_5", "subcategory_id": "c2_s7", "name": "تقرير عن التعاون مع معلم الحاسب لتصميم اختبار إلكتروني تفاعلي", "order": 5},
    {"id": "r_c2_s7_6", "subcategory_id": "c2_s7", "name": "توثيق لحلقة نقاش مع معلمي الصفوف الأولية حول تحسين القراءة", "order": 6},
    {"id": "r_c2_s7_7", "subcategory_id": "c2_s7", "name": "تقرير عن مشاركتي في مجموعة (واتساب) خاصة بمعلمي التخصص لتبادل الخبرات", "order": 7},
    {"id": "r_c2_s7_8", "subcategory_id": "c2_s7", "name": "توثيق لزيارة صفية لمعلم متميز في المدرسة للاستفادة من أسلوبه", "order": 8},
    {"id": "r_c2_s7_9", "subcategory_id": "c2_s7", "name": "تقرير عن ورشة داخلية قمت بتقديمها لزملائي عن استخدام السبورة الذكية", "order": 9},
    {"id": "r_c2_s7_10", "subcategory_id": "c2_s7", "name": "توثيق لتبادل مصادر تعليمية (فيديو، صور) مع معلمي العلوم", "order": 10},
    
    # c2_s8: التفكير الذاتي لتحسين الممارسات
    {"id": "r_c2_s8_1", "subcategory_id": "c2_s8", "name": "تقرير أسبوعي شخصي (مذكرة تأملات) عن أنجح الحصص والأخطاء التي وقعت فيها", "order": 1},
    {"id": "r_c2_s8_2", "subcategory_id": "c2_s8", "name": "توثيق لتسجيل فيديو لحصة دراسية ومشاهدتها لاحقًا لتقييم أدائي", "order": 2},
    {"id": "r_c2_s8_3", "subcategory_id": "c2_s8", "name": "تقرير عن ملاحظاتي الذاتية على أداء الطلاب في الاختبار القصير وسبب تدني درجاتهم", "order": 3},
    {"id": "r_c2_s8_4", "subcategory_id": "c2_s8", "name": "توثيق لخطة شخصية قمت بإعدادها لتطوير مهارة معينة لدي (مثل إدارة الصف)", "order": 4},
    {"id": "r_c2_s8_5", "subcategory_id": "c2_s8", "name": "تقرير عن قراءة كتاب تربوي وتدوين كيف سيساعدني في تطوير أسلوبي", "order": 5},
    {"id": "r_c2_s8_6", "subcategory_id": "c2_s8", "name": "توثيق لاستبيان رأي بسيط للطلاب عن حصتي وطريقة شرحي", "order": 6},
    {"id": "r_c2_s8_7", "subcategory_id": "c2_s8", "name": "تقرير عن تعديل استراتيجية تدريسية بعد شعوري بعدم مناسبتها للمستوى العمري", "order": 7},
    {"id": "r_c2_s8_8", "subcategory_id": "c2_s8", "name": "توثيق لأهدافي المهنية للسنة القادمة بناء على تحديّات هذا العام", "order": 8},
    {"id": "r_c2_s8_9", "subcategory_id": "c2_s8", "name": "تقرير عن مراجعة خططي السابقة وتحديد ما يمكن تحسينه", "order": 9},
    {"id": "r_c2_s8_10", "subcategory_id": "c2_s8", "name": "توثيق لتحديد نقاط ضعف لدي والعمل على حلها من خلال دورات تدريبية", "order": 10},
    
    # c3_s1: تنظيم اجتماعات دورية مع أولياء الأمور
    {"id": "r_c3_s1_1", "subcategory_id": "c3_s1", "name": "تقرير عن عقد لقاء فردي مع ولي أمر طالب متميز لمناقشة سبل دعمه", "order": 1},
    {"id": "r_c3_s1_2", "subcategory_id": "c3_s1", "name": "توثيق لمشاركتي في مجلس الآباء والمعلمين الفصلي", "order": 2},
    {"id": "r_c3_s1_3", "subcategory_id": "c3_s1", "name": "تقرير عن اجتماع عاجل مع ولي أمر طالب يعاني من صعوبات في التعلم", "order": 3},
    {"id": "r_c3_s1_4", "subcategory_id": "c3_s1", "name": "توثيق لدعوة أولياء الأمور لحضور معرض إنجازات الطلاب", "order": 4},
    {"id": "r_c3_s1_5", "subcategory_id": "c3_s1", "name": "تقرير عن تنظيم لقاء مفتوح لشرح خطة الفصل الدراسي الثاني لأولياء الأمور", "order": 5},
    {"id": "r_c3_s1_6", "subcategory_id": "c3_s1", "name": "توثيق اجتماع هاتفي مع ولي أمر طالب متغيب لتدارك الأمر", "order": 6},
    {"id": "r_c3_s1_7", "subcategory_id": "c3_s1", "name": "تقرير عن حوار مع ولي أمر طالب موهوب لتوفير أنشطة إثرائية له", "order": 7},
    {"id": "r_c3_s1_8", "subcategory_id": "c3_s1", "name": "توثيق لقاء مع أولياء أمور فصل كامل لمناقشة نتائج الاختبارات", "order": 8},
    {"id": "r_c3_s1_9", "subcategory_id": "c3_s1", "name": "تقرير عن اجتماع لمناقشة مشكلة سلوكية جماعية", "order": 9},
    {"id": "r_c3_s1_10", "subcategory_id": "c3_s1", "name": "توثيق للقاء ختامي مع أولياء الأمور لمناقشة التقرير السنوي للطالب", "order": 10},
    
    # c3_s2: إرسال تقارير منتظمة عن أداء الطلاب
    {"id": "r_c3_s2_1", "subcategory_id": "c3_s2", "name": "نموذج من تقرير شهري أرسلته لأولياء الأمور عن درجات الواجبات", "order": 1},
    {"id": "r_c3_s2_2", "subcategory_id": "c3_s2", "name": "تقرير أسبوعي عن السلوك العام للطالب عبر استمارة متابعة في دفتر الواجبات", "order": 2},
    {"id": "r_c3_s2_3", "subcategory_id": "c3_s2", "name": "توثيق لإشعار (إيجابي) أرسلته لولي الأمر عن تميز ابنه في النشاط", "order": 3},
    {"id": "r_c3_s2_4", "subcategory_id": "c3_s2", "name": "نموذج من بطاقة متابعة حفظ القرآن أو الجدول الدوري", "order": 4},
    {"id": "r_c3_s2_5", "subcategory_id": "c3_s2", "name": "تقرير عن إرسال كشف بنتائج الاختبارات القصيرة (شهرية) عبر البريد الإلكتروني", "order": 5},
    {"id": "r_c3_s2_6", "subcategory_id": "c3_s2", "name": "توثيق لتقرير سلوكي عن تحسن طالب كان كثير المشاكل", "order": 6},
    {"id": "r_c3_s2_7", "subcategory_id": "c3_s2", "name": "نموذج من إشعار ضعف لطلب دعم ولي الأمر في مادة معينة", "order": 7},
    {"id": "r_c3_s2_8", "subcategory_id": "c3_s2", "name": "تقرير عن إرسال خطة علاجية لولي الأمر لتطبيقها في المنزل", "order": 8},
    {"id": "r_c3_s2_9", "subcategory_id": "c3_s2", "name": "توثيق لبطاقة إنجاز أسبوعية للطلاب الضعاف لرفع معنوياتهم واطلاع أولياء أمورهم", "order": 9},
    {"id": "r_c3_s2_10", "subcategory_id": "c3_s2", "name": "تقرير فصلي مختوم من الإدارة عن مستوى الطالب", "order": 10},
    
    # c3_s3: استخدام وسائل التواصل الحديثة
    {"id": "r_c3_s3_1", "subcategory_id": "c3_s3", "name": "تقرير عن تفعيل مجموعة (واتساب) خاصة بالفصل للتنبيهات اليومية", "order": 1},
    {"id": "r_c3_s3_2", "subcategory_id": "c3_s3", "name": "توثيق لاستخدام خاصية الإشعارات في نظام (نور) أو (مدرستي) لإرسال التنبيهات", "order": 2},
    {"id": "r_c3_s3_3", "subcategory_id": "c3_s3", "name": "تقرير عن استخدام البريد الإلكتروني لإرسال ملفات تفاعلية لدعم الطلاب", "order": 3},
    {"id": "r_c3_s3_4", "subcategory_id": "c3_s3", "name": "توثيق للتواصل عبر تطبيق (توكلنا) للاستفسار عن حالة الطالب الصحية", "order": 4},
    {"id": "r_c3_s3_5", "subcategory_id": "c3_s3", "name": "تقرير عن إنشاء قناة على (تليجرام) لنشر ملخصات الدروس والفيديوهات التعليمية", "order": 5},
    {"id": "r_c3_s3_6", "subcategory_id": "c3_s3", "name": "توثيق لاستخدام استبيانات (جوجل فورم) لاستطلاع رأي أولياء الأمور", "order": 6},
    {"id": "r_c3_s3_7", "subcategory_id": "c3_s3", "name": "تقرير عن التواصل الفردي عبر الرسائل النصية القصيرة (SMS)", "order": 7},
    {"id": "r_c3_s3_8", "subcategory_id": "c3_s3", "name": "توثيق لمشاركة صور الأنشطة الصفية مع أولياء الأمور عبر تطبيقات آمنة", "order": 8},
    {"id": "r_c3_s3_9", "subcategory_id": "c3_s3", "name": "تقرير عن الرد على استفسارات أولياء الأمور عبر خاصية الدردشة في منصة المدرسة", "order": 9},
    {"id": "r_c3_s3_10", "subcategory_id": "c3_s3", "name": "توثيق لاستخدام تقويم جوجل لمشاركة أولياء الأمور بمواعيد الاختبارات الهامة", "order": 10},
    
    # c3_s4: الاستجابة والاستماع لملاحظات أولياء الأمور
    {"id": "r_c3_s4_1", "subcategory_id": "c3_s4", "name": "تقرير عن استقبال شكوى ولي أمر حول صعوبة المنهج ومناقشتها معه", "order": 1},
    {"id": "r_c3_s4_2", "subcategory_id": "c3_s4", "name": "توثيق لملاحظة ولي أمر عن تنمر طالب على ابنه واتخاذ الإجراءات المناسبة", "order": 2},
    {"id": "r_c3_s4_3", "subcategory_id": "c3_s4", "name": "تقرير عن اجتماع مع ولي أمر استجبت فيه لطلبه بتغيير طريقة التواصل مع ابنه", "order": 3},
    {"id": "r_c3_s4_4", "subcategory_id": "c3_s4", "name": "توثيق لتعاوني مع ولي أمر طالب يعاني من قلق الاختبارات ووضع خطة تهدئة", "order": 4},
    {"id": "r_c3_s4_5", "subcategory_id": "c3_s4", "name": "تقرير عن تعديل موعد تسليم واجب ثقيل بعد استفسار مجموعة من أولياء الأمور", "order": 5},
    {"id": "r_c3_s4_6", "subcategory_id": "c3_s4", "name": "توثيق لمناقشة ولي أمر حول طريقة الشرح وتوضيح الهدف منها", "order": 6},
    {"id": "r_c3_s4_7", "subcategory_id": "c3_s4", "name": "تقرير عن استقبال اقتراح ولي أمر لرحلة مدرسية وأخذ رأي الإدارة فيه", "order": 7},
    {"id": "r_c3_s4_8", "subcategory_id": "c3_s4", "name": "توثيق لحل مشكلة سوء فهم بين الطالب والمعلم بالتعاون مع ولي الأمر", "order": 8},
    {"id": "r_c3_s4_9", "subcategory_id": "c3_s4", "name": "تقرير عن استفسار ولي أمر عن سر تأخر ابنه الدراسي وتقديم خطة دعم له", "order": 9},
    {"id": "r_c3_s4_10", "subcategory_id": "c3_s4", "name": "توثيق لشكر ولي أمر بعد حل مشكلة كان يعاني منها مع ابنه", "order": 10},
    
    # c3_s5: تشجيع أولياء الأمور بالمشاركة
    {"id": "r_c3_s5_1", "subcategory_id": "c3_s5", "name": "تقرير عن دعوة ولي أمر مهندس للتحدث مع الطلاب عن مهنته (للتوجيه المهني)", "order": 1},
    {"id": "r_c3_s5_2", "subcategory_id": "c3_s5", "name": "توثيق لمشاركة ولي أمر في تحكيم مسابقة مدرسية", "order": 2},
    {"id": "r_c3_s5_3", "subcategory_id": "c3_s5", "name": "تقرير عن تشجيع ولي الأمر على حضور حصة قراءة مع ابنه في الصف (أسبوع القراءة)", "order": 3},
    {"id": "r_c3_s5_4", "subcategory_id": "c3_s5", "name": "توثيق لمشاركة ولي أمر في تنظيم رحلة مدرسية", "order": 4},
    {"id": "r_c3_s5_5", "subcategory_id": "c3_s5", "name": "تقرير عن دعوة أولياء الأمور للمشاركة في تزيين الفصل بالمناسبات", "order": 5},
    {"id": "r_c3_s5_6", "subcategory_id": "c3_s5", "name": "توثيق لمشاركة أولياء الأمور في فعالية اليوم المفتوح بالمدرسة", "order": 6},
    {"id": "r_c3_s5_7", "subcategory_id": "c3_s5", "name": "تقرير عن تشجيع أولياء الأمور على التطوع في الإشراف على مكتبة المدرسة", "order": 7},
    {"id": "r_c3_s5_8", "subcategory_id": "c3_s5", "name": "توثيق لمساهمة ولي أمر في توفير مواد خام لأنشطة فنية", "order": 8},
    {"id": "r_c3_s5_9", "subcategory_id": "c3_s5", "name": "تقرير عن مشاركة ولي أمر في لجنة تحكيم مشاريع الطلاب النهائية", "order": 9},
    {"id": "r_c3_s5_10", "subcategory_id": "c3_s5", "name": "توثيق لاستضافة أحد أولياء الأمور لتقديم ورشة عن الإسعافات الأولية", "order": 10},
    
    # c4_s1: استخدام التعلم النشط
    {"id": "r_c4_s1_1", "subcategory_id": "c4_s1", "name": "تقرير عن تطبيق استراتيجية التعلم التعاوني في حصة العلوم بتقسيم الطلاب لمجموعات", "order": 1},
    {"id": "r_c4_s1_2", "subcategory_id": "c4_s1", "name": "توثيق لتنفيذ استراتيجية العصف الذهني لطلاب المتوسط لطرح أفكار حول موضوع الدرس", "order": 2},
    {"id": "r_c4_s1_3", "subcategory_id": "c4_s1", "name": "تقرير عن استخدام استراتيجية المناقشة الجماعية في حصة الدراسات الإسلامية", "order": 3},
    {"id": "r_c4_s1_4", "subcategory_id": "c4_s1", "name": "توثيق لعروض تقديمية قدمها طلاب الثانوي عن مشاريعهم البحثية", "order": 4},
    {"id": "r_c4_s1_5", "subcategory_id": "c4_s1", "name": "تقرير عن تطبيق استراتيجية لعب الأدوار في حصة اللغة الإنجليزية لطلاب الابتدائي", "order": 5},
    {"id": "r_c4_s1_6", "subcategory_id": "c4_s1", "name": "توثيق لاستخدام استراتيجية الكرسي الساخن مع طالب يجيب على أسئلة زملائه", "order": 6},
    {"id": "r_c4_s1_7", "subcategory_id": "c4_s1", "name": "تقرير عن تنفيذ استراتيجية مثلث الاستماع في حصة القراءة", "order": 7},
    {"id": "r_c4_s1_8", "subcategory_id": "c4_s1", "name": "توثيق لاستخدام استراتيجية فكر-زاوج-شارك في حل المسائل الرياضية", "order": 8},
    {"id": "r_c4_s1_9", "subcategory_id": "c4_s1", "name": "تقرير عن تطبيق استراتيجية المناظرة بين مجموعتين من طلاب الثانوي", "order": 9},
    {"id": "r_c4_s1_10", "subcategory_id": "c4_s1", "name": "توثيق لاستخدام استراتيجية التعلم باللعب في حصة الرياضيات للصفوف الأولية", "order": 10},
    
    # c4_s2: التعلم القائم على المشاريع
    {"id": "r_c4_s2_1", "subcategory_id": "c4_s2", "name": "تقرير عن مشروع مجسم المجموعة الشمسية لطلاب الصف السادس الابتدائي", "order": 1},
    {"id": "r_c4_s2_2", "subcategory_id": "c4_s2", "name": "توثيق لمشروع بحثي عن التلوث البيئي لطلاب المرحلة المتوسطة", "order": 2},
    {"id": "r_c4_s2_3", "subcategory_id": "c4_s2", "name": "تقرير عن مشروع صحيفة حائطية عن اليوم العالمي للغة العربية", "order": 3},
    {"id": "r_c4_s2_4", "subcategory_id": "c4_s2", "name": "توثيق لمشروع ابتكار آلة بسيطة في مادة العلوم للصف الثالث المتوسط", "order": 4},
    {"id": "r_c4_s2_5", "subcategory_id": "c4_s2", "name": "تقرير عن مشروع معرض التراث بالتعاون مع معلم التربية الفنية", "order": 5},
    {"id": "r_c4_s2_6", "subcategory_id": "c4_s2", "name": "توثيق لمشروع إعداد وجبة صحية في حصة الاقتصاد المنزلي", "order": 6},
    {"id": "r_c4_s2_7", "subcategory_id": "c4_s2", "name": "تقرير عن مشروع تصميم لعبة تعليمية لطلاب الحاسب الآلي", "order": 7},
    {"id": "r_c4_s2_8", "subcategory_id": "c4_s2", "name": "توثيق لمشروع الرحلات المعرفية عبر الإنترنت في حصة التاريخ", "order": 8},
    {"id": "r_c4_s2_9", "subcategory_id": "c4_s2", "name": "تقرير عن مشروع إعادة التدوير للحفاظ على البيئة المدرسية", "order": 9},
    {"id": "r_c4_s2_10", "subcategory_id": "c4_s2", "name": "توثيق لمشروع الاختراع الصغير في حصة العلوم للصفوف العليا", "order": 10},
    
    # c4_s3: استراتيجيات تنمية التفكير
    {"id": "r_c4_s3_1", "subcategory_id": "c4_s3", "name": "تقرير عن تطبيق استراتيجية حل المشكلات في حصة الرياضيات", "order": 1},
    {"id": "r_c4_s3_2", "subcategory_id": "c4_s3", "name": "توثيق لاستخدام استراتيجية القبعات الست في مناقشة قضية اجتماعية مع طلاب الثانوي", "order": 2},
    {"id": "r_c4_s3_3", "subcategory_id": "c4_s3", "name": "تقرير عن تطبيق استراتيجية التفكير الناقد بتحليل نصوص في حصة اللغة العربية", "order": 3},
    {"id": "r_c4_s3_4", "subcategory_id": "c4_s3", "name": "توثيق لاستخدام استراتيجية العصف الذهني لتوليد أفكار إبداعية لطلاب الموهوبين", "order": 4},
    {"id": "r_c4_s3_5", "subcategory_id": "c4_s3", "name": "تقرير عن تطبيق استراتيجية الخرائط الذهنية في تلخيص درس العلوم", "order": 5},
    {"id": "r_c4_s3_6", "subcategory_id": "c4_s3", "name": "توثيق لاستخدام استراتيجية الأسئلة السابرة (لماذا؟ كيف؟ ماذا لو؟) لتوسيع التفكير", "order": 6},
    {"id": "r_c4_s3_7", "subcategory_id": "c4_s3", "name": "تقرير عن تطبيق استراتيجية التفكير الإبداعي في حصة التعبير الكتابي", "order": 7},
    {"id": "r_c4_s3_8", "subcategory_id": "c4_s3", "name": "توثيق لاستخدام استراتيجية القصة المشوقة لحل مشكلة خيالية", "order": 8},
    {"id": "r_c4_s3_9", "subcategory_id": "c4_s3", "name": "تقرير عن تطبيق استراتيجية التعلم بالاكتشاف في معمل العلوم", "order": 9},
    {"id": "r_c4_s3_10", "subcategory_id": "c4_s3", "name": "توثيق لاستخدام استراتيجية المقارنة والتبويب في تصنيف الكائنات الحية", "order": 10},
    
    # c4_s4: استخدام الوسائل البصرية والسمعية
    {"id": "r_c4_s4_1", "subcategory_id": "c4_s4", "name": "تقرير عن استخدام عروض البوربوينت المصورة في شرح درس عن الفضاء", "order": 1},
    {"id": "r_c4_s4_2", "subcategory_id": "c4_s4", "name": "توثيق لعرض فيديو تعليمي عن عملية البناء الضوئي في حصة الأحياء", "order": 2},
    {"id": "r_c4_s4_3", "subcategory_id": "c4_s4", "name": "تقرير عن استخدام البطاقات المصورة لتعليم المفردات لطلاب الابتدائي", "order": 3},
    {"id": "r_c4_s4_4", "subcategory_id": "c4_s4", "name": "توثيق لاستخدام الخرائط الصماء في حصة الدراسات الاجتماعية", "order": 4},
    {"id": "r_c4_s4_5", "subcategory_id": "c4_s4", "name": "تقرير عن تشغيل مقاطع صوتية (للقرآن، الأناشيد) في حصة التربية الإسلامية", "order": 5},
    {"id": "r_c4_s4_6", "subcategory_id": "c4_s4", "name": "توثيق لاستخدام الرسوم البيانية في توضيح نتائج استبيان مع طلاب الثانوي", "order": 6},
    {"id": "r_c4_s4_7", "subcategory_id": "c4_s4", "name": "تقرير عن استخدام السبورة الذكية لعرض صور تفاعلية عن الحضارات القديمة", "order": 7},
    {"id": "r_c4_s4_8", "subcategory_id": "c4_s4", "name": "توثيق لاستخدام الإنفوجرافيك في تلخيص قواعد النحو", "order": 8},
    {"id": "r_c4_s4_9", "subcategory_id": "c4_s4", "name": "تقرير عن استخدام المجسمات التعليمية (الهيكل العظمي، الكرة الأرضية)", "order": 9},
    {"id": "r_c4_s4_10", "subcategory_id": "c4_s4", "name": "توثيق لعرض فيلم قصير عن السيرة النبوية في حصة التربية الإسلامية", "order": 10},
    
    # c4_s5: التعليم المتمايز
    {"id": "r_c4_s5_1", "subcategory_id": "c4_s5", "name": "تقرير عن تخصيص أنشطة بصرية (رسوم، خرائط) للطلاب ذوي النمط البصري", "order": 1},
    {"id": "r_c4_s5_2", "subcategory_id": "c4_s5", "name": "توثيق لتوفير أنشطة سمعية (تسجيلات، مناقشات) للطلاب ذوي النمط السمعي", "order": 2},
    {"id": "r_c4_s5_3", "subcategory_id": "c4_s5", "name": "تقرير عن تصميم أنشطة حركية (تجارب، نماذج) للطلاب ذوي النمط الحركي", "order": 3},
    {"id": "r_c4_s5_4", "subcategory_id": "c4_s5", "name": "توثيق لتقديم خيارات متعددة للواجب (كتابة تقرير، رسم مجسم، إعداد عرض)", "order": 4},
    {"id": "r_c4_s5_5", "subcategory_id": "c4_s5", "name": "تقرير عن تقسيم الطلاب لمجموعات حسب مستوياتهم وتقديم مهام مناسبة", "order": 5},
    {"id": "r_c4_s5_6", "subcategory_id": "c4_s5", "name": "توثيق لإعطاء وقت إضافي للطلاب بطيئي التعلم لإنجاز المهام", "order": 6},
    {"id": "r_c4_s5_7", "subcategory_id": "c4_s5", "name": "تقرير عن توفير أنشطة إثرائية للطلاب المتفوقين والمتقدمين", "order": 7},
    {"id": "r_c4_s5_8", "subcategory_id": "c4_s5", "name": "توثيق لاستخدام نصوص متنوعة المستوى في حصة القراءة", "order": 8},
    {"id": "r_c4_s5_9", "subcategory_id": "c4_s5", "name": "تقرير عن تنويع أسئلة التقويم لتناسب الجميع", "order": 9},
    {"id": "r_c4_s5_10", "subcategory_id": "c4_s5", "name": "توثيق لتقديم الدعم الفردي للطلاب ذوي صعوبات التعلم أثناء الحصة", "order": 10},
    
    # c4_s6: استراتيجيات التعلم الحديثة
    {"id": "r_c4_s6_1", "subcategory_id": "c4_s6", "name": "تقرير عن تطبيق استراتيجية الصف المقلوب بتكليف الطلاب بمشاهدة فيديو قبل الحصة", "order": 1},
    {"id": "r_c4_s6_2", "subcategory_id": "c4_s6", "name": "توثيق لاستخدام استراتيجية التعلم بالألعاب الإلكترونية عبر منصة (كاهوت)", "order": 2},
    {"id": "r_c4_s6_3", "subcategory_id": "c4_s6", "name": "تقرير عن تطبيق استراتيجية الرحلات المعرفية عبر الإنترنت (WebQuest)", "order": 3},
    {"id": "r_c4_s6_4", "subcategory_id": "c4_s6", "name": "توثيق لاستخدام استراتيجية التعلم بالترفيه من خلال ألعاب تعليمية ورقية", "order": 4},
    {"id": "r_c4_s6_5", "subcategory_id": "c4_s6", "name": "تقرير عن تطبيق استراتيجية مسرح الدمى مع طلاب الصفوف الأولية", "order": 5},
    {"id": "r_c4_s6_6", "subcategory_id": "c4_s6", "name": "توثيق لاستخدام استراتيجية المعارض العلمية لعرض مشاريع الطلاب", "order": 6},
    {"id": "r_c4_s6_7", "subcategory_id": "c4_s6", "name": "تقرير عن تطبيق استراتيجية التعلم بالمشاريع التعاونية عبر منصات إلكترونية", "order": 7},
    {"id": "r_c4_s6_8", "subcategory_id": "c4_s6", "name": "توثيق لاستخدام استراتيجية القصة الرقمية في سرد الأحداث التاريخية", "order": 8},
    {"id": "r_c4_s6_9", "subcategory_id": "c4_s6", "name": "تقرير عن تطبيق استراتيجية التعلم التبادلي في تدريس النصوص الأدبية", "order": 9},
    {"id": "r_c4_s6_10", "subcategory_id": "c4_s6", "name": "توثيق لاستخدام استراتيجية الألعاب اللغوية في حصة القواعد النحوية", "order": 10},
    
    # c4_s7: التعلم التعاوني
    {"id": "r_c4_s7_1", "subcategory_id": "c4_s7", "name": "تقرير عن تطبيق استراتيجية التعلم التعاوني (جيجسو) في حصة الدراسات الاجتماعية", "order": 1},
    {"id": "r_c4_s7_2", "subcategory_id": "c4_s7", "name": "توثيق لتوزيع الطلاب على مجموعات عمل متعاونة في حصة العلوم", "order": 2},
    {"id": "r_c4_s7_3", "subcategory_id": "c4_s7", "name": "تقرير عن تطبيق استراتيجية مجموعات الخبراء في حل المسائل الرياضية المعقدة", "order": 2},
    # ملاحظة: بسبب طول القائمة، تم تضمين جزء فقط. الملف الكامل سيحتوي على جميع التقارير الـ 1100+ تقرير
]

# إدارات التعليم
EDUCATION_OFFICES = [
    "الإدارة العامة للتعليم بمنطقة مكة المكرمة",
    "الإدارة العامة للتعليم بمنطقة الرياض",
    "الإدارة العامة للتعليم بمنطقة المدينة المنورة",
    "الإدارة العامة للتعليم بالمنطقة الشرقية",
    "الإدارة العامة للتعليم بمنطقة القصيم",
    "الإدارة العامة للتعليم بمنطقة عسير",
    "الإدارة العامة للتعليم بمنطقة تبوك",
    "الإدارة العامة للتعليم بمنطقة حائل",
    "الإدارة العامة للتعليم بمنطقة الحدود الشمالية",
    "الإدارة العامة للتعليم بمنطقة جازان",
    "الإدارة العامة للتعليم بمنطقة نجران",
    "الإدارة العامة للتعليم بمنطقة الباحة",
    "الإدارة العامة للتعليم بمنطقة الجوف",
    "الإدارة العامة للتعليم بمحافظة الأحساء",
    "الإدارة العامة للتعليم بمحافظة الطائف",
    "الإدارة العامة للتعليم بمحافظة جدة"
]

# المواد الدراسية
SCHOOL_SUBJECTS = [
    "القرآن الكريم",
    "الدراسات الإسلامية",
    "اللغة العربية",
    "الرياضيات",
    "العلوم",
    "الدراسات الاجتماعية",
    "اللغة الإنجليزية",
    "التربية الفنية",
    "التربية البدنية",
    "المهارات الرقمية",
    "المهارات الحياتية والأسرية",
    "التفكير الناقد",
    "التربية المهنية"
]

# الصفوف الدراسية
SCHOOL_GRADES = [
    "الصف الأول الابتدائي",
    "الصف الثاني الابتدائي",
    "الصف الثالث الابتدائي",
    "الصف الرابع الابتدائي",
    "الصف الخامس الابتدائي",
    "الصف السادس الابتدائي",
    "الصف الأول المتوسط",
    "الصف الثاني المتوسط",
    "الصف الثالث المتوسط",
    "الصف الأول الثانوي",
    "الصف الثاني الثانوي",
    "الصف الثالث الثانوي"
]

# المستهدفون
TARGET_AUDIENCES = [
    "الطلاب",
    "المعلمون",
    "أولياء الأمور",
    "المجتمع المحلي",
    "الإدارة المدرسية",
    "الموهوبون",
    "طلاب صعوبات التعلم",
    "الطلاب المتفوقون",
    "الطلاب المتعثرون"
]

# أماكن التنفيذ
IMPLEMENTATION_PLACES = [
    "قاعة الدرس",
    "مصادر التعلم",
    "مختبر العلوم",
    "معمل الحاسب",
    "ساحة المدرسة",
    "المكتبة",
    "قاعة النشاط",
    "المسرح المدرسي",
    "الفصول الافتراضية",
    "الملعب الرياضي"
]

# الأدوات والوسائل التعليمية
EDUCATIONAL_TOOLS = [
    "سبورة",
    "سبورة ذكية",
    "جهاز عرض",
    "أوراق عمل",
    "حاسب",
    "عرض تقديمي",
    "بطاقات تعليمية",
    "صور توضيحية",
    "كتاب",
    "أدوات رياضية",
    "جهاز لوحي",
    "منصة مدرستي",
    "نظام نور",
    "تطبيقات تعليمية",
    "فيديو تعليمي"
]

# ---------- برومبت الذكاء الاصطناعي ----------
AI_PROMPT_TEMPLATE = """أنت خبير تربوي تعليمي محترف تمتلك خبرة ميدانية واسعة في التعليم العام.  
اعتمد منظورًا تربويًا مهنيًا احترافيًا يركّز على تحسين جودة التعليم، ودعم المعلم، وتعزيز بيئة التعلّم، وخدمة القيادة المدرسية.  

التقرير المطلوب: "{report_name}"
وهو يندرج تحت التصنيف الفرعي: "{subcategory_name}"
ضمن المعيار التربوي: "{criterion_name}"

{subject_line}
{lesson_line}
{grade_line}
{target_line}
{place_line}
{count_line}

**توجيهات مهنية:**
- كن موضوعيًا ومتزنًا وبنّاءً  
- قدّم الملاحظات بصيغة تطويرية غير نقدية  
- راعِ واقع الميدان التعليمي وسياق المدرسة  
- اربط بين المعلم والطالب والمنهج والبيئة الصفية والقيادة المدرسية  
- ركّز على جودة التعليم وأثر الممارسات على تعلم الطلاب  
- التزم بلغة عربية فصيحة سليمة وخالية من الأخطاء  
- اجعل المحتوى وكأنه تقرير مقدم من معلم عن ممارسة فعلية قام بها

**شروط المحتوى:**
اكتب محتوى كل حقل بصيغة تقريرية مهنية وكأنه صادر عن المعلم.
لا تكتب أبداً عنوان الحقل داخل المحتوى ولا تعِد صياغته بصيغة مباشرة.
يجب أن يحتوي كل حقل على ما يقارب 25 كلمة.
ابدأ بالمضمون مباشرة دون تمهيد أو عبارات إنشائية.
احرص على وجود ترابط منطقي بين الحقول المطلوبة.
اجعل الهدف النهائي للمحتوى تحسين الممارسة التعليمية ودعم التطوير المهني المستدام.
راعِ الوضوح والترابط، واجعل كل جملة تضيف قيمة تعليمية فعلية.

**الحقول المطلوبة:**
1. الهدف التربوي
2. نبذة مختصرة  
3. إجراءات التنفيذ
4. الاستراتيجيات المستخدمة
5. نقاط القوة
6. نقاط التحسين
7. التوصيات

يرجى تقديم الإجابة باللغة العربية الفصحى، وتنظيمها بحيث يكون كل حقل في سطر منفصل يبدأ برقمه فقط دون ذكر العنوان."""

def build_ai_prompt(report_name: str, subcategory_name: str, criterion_name: str, report_data: dict = None):
    """بناء البرومت المناسب للذكاء الاصطناعي"""
    if not report_data:
        report_data = {}
    
    subject_line = f"المادة: {report_data.get('subject', '')}" if report_data.get('subject') else ""
    lesson_line = f"الدرس: {report_data.get('lesson', '')}" if report_data.get('lesson') else ""
    grade_line = f"الصف: {report_data.get('grade', '')}" if report_data.get('grade') else ""
    target_line = f"المستهدفون: {report_data.get('target', '')}" if report_data.get('target') else ""
    place_line = f"مكان التنفيذ: {report_data.get('place', '')}" if report_data.get('place') else ""
    count_line = f"عدد الحضور: {report_data.get('count', '')}" if report_data.get('count') else ""
    
    return AI_PROMPT_TEMPLATE.format(
        report_name=report_name,
        subcategory_name=subcategory_name,
        criterion_name=criterion_name,
        subject_line=subject_line,
        lesson_line=lesson_line,
        grade_line=grade_line,
        target_line=target_line,
        place_line=place_line,
        count_line=count_line
    )

# ============================================================================
# دوال مساعدة للبحث في البيانات
# ============================================================================

def get_criterion_by_id(criterion_id: str):
    """الحصول على معيار تربوي حسب المعرف"""
    for criterion in CRITERIA:
        if criterion["id"] == criterion_id:
            return criterion
    return None

def get_subcategory_by_id(subcategory_id: str):
    """الحصول على تصنيف فرعي حسب المعرف"""
    for subcategory in SUBCATEGORIES:
        if subcategory["id"] == subcategory_id:
            return subcategory
    return None

def get_report_by_id(report_id: str):
    """الحصول على تقرير حسب المعرف"""
    for report in REPORTS:
        if report["id"] == report_id:
            return report
    return None

def get_subcategories_by_criterion(criterion_id: str):
    """الحصول على جميع التصنيفات الفرعية لمعيار معين"""
    return [s for s in SUBCATEGORIES if s["criterion_id"] == criterion_id]

def get_reports_by_subcategory(subcategory_id: str):
    """الحصول على جميع التقارير لتصنيف فرعي معين"""
    return [r for r in REPORTS if r["subcategory_id"] == subcategory_id]

# ============================================================================
# المسارات (Routes)
# ============================================================================

@app.get("/")
def root():
    return {"status": "running", "message": "Teacher Reports API"}

@app.get("/health")
def health(_: int = Depends(activation_required)):
    return {"status": "ok"}

# ---------- مسارات الاشتراك ----------
@app.get("/subscription/status")
def subscription_status(code_id: int = Depends(activation_required)):
    conn = get_connection()
    cur = conn.cursor()

    cur.execute("""
        SELECT
            expires_at,
            usage_limit,
            usage_count
        FROM activation_codes
        WHERE id = ?
    """, (code_id,))
    row = cur.fetchone()
    conn.close()

    if not row:
        raise HTTPException(status_code=404, detail="Subscription not found")

    expires_at, usage_limit, usage_count = row
    now = datetime.utcnow()

    expired = False
    if expires_at and datetime.fromisoformat(expires_at) < now:
        expired = True
    if usage_limit is not None and usage_count >= usage_limit:
        expired = True

    return {
        "expires_at": expires_at,
        "usage_limit": usage_limit,
        "usage_used": usage_count,
        "usage_remaining": (
            max(usage_limit - usage_count, 0)
            if usage_limit is not None else None
        ),
        "expired": expired
    }

# ---------- المسار الرئيسي للذكاء الاصطناعي ----------
@app.post("/ask")
def ask(
    req: Req,
    code_id: int = Depends(activation_required)
):
    conn = get_connection()
    cur = conn.cursor()

    cur.execute("""
        UPDATE activation_codes
        SET usage_count = usage_count + 1,
            last_used_at = ?
        WHERE id = ?
    """, (datetime.utcnow().isoformat(), code_id))

    conn.commit()
    conn.close()

    genai.configure(api_key=get_api_key())
    model = genai.GenerativeModel("models/gemini-2.5-flash-lite")
    response = model.generate_content(req.prompt)

    return {"answer": response.text}

# ---------- مسارات البيانات الجديدة ----------

@app.get("/api/criteria")
def get_all_criteria():
    """جلب جميع المعايير التربوية"""
    return {"criteria": CRITERIA}

@app.get("/api/criteria/{criterion_id}")
def get_criterion(criterion_id: str):
    """جلب معيار تربوي محدد"""
    criterion = get_criterion_by_id(criterion_id)
    if not criterion:
        raise HTTPException(status_code=404, detail="Criterion not found")
    return criterion

@app.get("/api/criteria/{criterion_id}/subcategories")
def get_subcategories(criterion_id: str):
    """جلب جميع التصنيفات الفرعية لمعيار معين"""
    criterion = get_criterion_by_id(criterion_id)
    if not criterion:
        raise HTTPException(status_code=404, detail="Criterion not found")
    
    subcategories = get_subcategories_by_criterion(criterion_id)
    return {
        "criterion": criterion,
        "subcategories": subcategories
    }

@app.get("/api/subcategories/{subcategory_id}")
def get_subcategory(subcategory_id: str):
    """جلب تصنيف فرعي محدد"""
    subcategory = get_subcategory_by_id(subcategory_id)
    if not subcategory:
        raise HTTPException(status_code=404, detail="Subcategory not found")
    return subcategory

@app.get("/api/subcategories/{subcategory_id}/reports")
def get_reports(subcategory_id: str):
    """جلب جميع التقارير لتصنيف فرعي معين"""
    subcategory = get_subcategory_by_id(subcategory_id)
    if not subcategory:
        raise HTTPException(status_code=404, detail="Subcategory not found")
    
    reports = get_reports_by_subcategory(subcategory_id)
    return {
        "subcategory": subcategory,
        "reports": reports
    }

@app.get("/api/reports/{report_id}")
def get_report(report_id: str):
    """جلب تقرير محدد"""
    report = get_report_by_id(report_id)
    if not report:
        raise HTTPException(status_code=404, detail="Report not found")
    
    # جلب التصنيف الفرعي المرتبط
    subcategory = get_subcategory_by_id(report["subcategory_id"])
    criterion = None
    if subcategory:
        criterion = get_criterion_by_id(subcategory["criterion_id"])
    
    return {
        "report": report,
        "subcategory": subcategory,
        "criterion": criterion
    }

@app.get("/api/full-structure")
def get_full_structure():
    """جلب الهيكل الكامل (معايير + تصنيفات فرعية + تقارير)"""
    result = []
    for criterion in CRITERIA:
        criterion_data = criterion.copy()
        subcategories = get_subcategories_by_criterion(criterion["id"])
        criterion_data["subcategories"] = []
        
        for subcategory in subcategories:
            subcategory_data = subcategory.copy()
            reports = get_reports_by_subcategory(subcategory["id"])
            subcategory_data["reports"] = reports
            criterion_data["subcategories"].append(subcategory_data)
        
        result.append(criterion_data)
    
    return {"structure": result}

# ---------- مسارات البيانات الإضافية ----------
@app.get("/api/education-offices")
def get_education_offices():
    """جلب جميع إدارات التعليم"""
    return EDUCATION_OFFICES

@app.get("/api/school-subjects")
def get_school_subjects():
    """جلب جميع المواد الدراسية"""
    return SCHOOL_SUBJECTS

@app.get("/api/school-grades")
def get_school_grades():
    """جلب جميع الصفوف الدراسية"""
    return SCHOOL_GRADES

@app.get("/api/target-audiences")
def get_target_audiences():
    """جلب جميع الفئات المستهدفة"""
    return TARGET_AUDIENCES

@app.get("/api/implementation-places")
def get_implementation_places():
    """جلب جميع أماكن التنفيذ"""
    return IMPLEMENTATION_PLACES

@app.get("/api/educational-tools")
def get_educational_tools():
    """جلب جميع الأدوات التعليمية"""
    return EDUCATIONAL_TOOLS

@app.get("/api/search-reports")
def search_reports(q: str = Query(..., min_length=2)):
    """البحث في التقارير"""
    results = []
    q_lower = q.lower()
    
    for report in REPORTS:
        if q_lower in report["name"].lower():
            subcategory = get_subcategory_by_id(report["subcategory_id"])
            criterion = None
            if subcategory:
                criterion = get_criterion_by_id(subcategory["criterion_id"])
            
            results.append({
                "report": report,
                "subcategory_name": subcategory["name"] if subcategory else None,
                "criterion_name": criterion["name"] if criterion else None
            })
    
    return {"results": results[:20]}  # حد أقصى 20 نتيجة

# ---------- مسار توليد محتوى التقرير ----------
@app.post("/api/generate-report-content")
def generate_report_content(
    req: GenerateReportRequest,
    code_id: int = Depends(activation_required)
):
    """
    توليد محتوى التقرير باستخدام الذكاء الاصطناعي
    """
    # التحقق من وجود التقرير
    report = get_report_by_id(req.report_id)
    if not report:
        raise HTTPException(status_code=404, detail="Report not found")
    
    # التحقق من وجود التصنيف الفرعي
    subcategory = get_subcategory_by_id(req.subcategory_id)
    if not subcategory:
        raise HTTPException(status_code=404, detail="Subcategory not found")
    
    # التحقق من تطابق التقرير مع التصنيف الفرعي
    if report["subcategory_id"] != req.subcategory_id:
        raise HTTPException(status_code=400, detail="Report does not belong to this subcategory")
    
    # التحقق من وجود المعيار التربوي
    criterion = get_criterion_by_id(req.criterion_id)
    if not criterion:
        raise HTTPException(status_code=404, detail="Criterion not found")
    
    # التحقق من تطابق التصنيف الفرعي مع المعيار
    if subcategory["criterion_id"] != req.criterion_id:
        raise HTTPException(status_code=400, detail="Subcategory does not belong to this criterion")
    
    # بناء البرومت المناسب
    prompt = build_ai_prompt(
        report_name=report["name"],
        subcategory_name=subcategory["name"],
        criterion_name=criterion["name"],
        report_data=req.report_data
    )
    
    # تحديث عدد الاستخدامات
    conn = get_connection()
    cur = conn.cursor()
    
    cur.execute("""
        UPDATE activation_codes
        SET usage_count = usage_count + 1,
            last_used_at = ?
        WHERE id = ?
    """, (datetime.utcnow().isoformat(), code_id))
    
    conn.commit()
    conn.close()
    
    # استخدام الذكاء الاصطناعي
    genai.configure(api_key=get_api_key())
    model = genai.GenerativeModel("models/gemini-2.5-flash-lite")
    response = model.generate_content(prompt)
    
    return {
        "content": response.text,
        "report_id": req.report_id,
        "report_name": report["name"],
        "subcategory_name": subcategory["name"],
        "criterion_name": criterion["name"],
        "generated_at": datetime.utcnow().isoformat()
    }

# ---------- Admin APIs ----------
@app.post("/admin/generate", dependencies=[Depends(admin_auth)])
def admin_generate(req: GenerateKeyReq):
    if req.plan not in PLANS:
        raise HTTPException(status_code=400, detail="Invalid plan")

    plan = PLANS[req.plan]
    now = datetime.utcnow()
    expires_at = now

    if "minutes" in plan:
        expires_at += timedelta(minutes=plan["minutes"])
    if "days" in plan:
        expires_at += timedelta(days=plan["days"])

    return {
        "code": create_key(
            expires_at.isoformat(),
            plan["usage"]
        ),
        "expires_at": expires_at.isoformat(),
        "usage_limit": plan["usage"]
    }

@app.get("/admin/codes", dependencies=[Depends(admin_auth)])
def admin_codes():
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("""
        SELECT
            id,
            code,
            is_active,
            expires_at,
            usage_limit,
            usage_count
        FROM activation_codes
    """)
    rows = cur.fetchall()
    conn.close()

    now = datetime.utcnow()
    result = []

    for r in rows:
        expired = False
        if r[3] and datetime.fromisoformat(r[3]) < now:
            expired = True
        if r[4] is not None and r[5] >= r[4]:
            expired = True

        result.append({
            "id": r[0],
            "code": r[1],
            "active": bool(r[2]),
            "expires_at": r[3],
            "usage_limit": r[4],
            "usage_count": r[5],
            "expired": expired
        })

    return result

@app.put("/admin/code/{code_id}/toggle", dependencies=[Depends(admin_auth)])
def admin_toggle(code_id: int):
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("""
        UPDATE activation_codes
        SET is_active = CASE WHEN is_active=1 THEN 0 ELSE 1 END
        WHERE id = ?
    """, (code_id,))
    conn.commit()
    conn.close()
    return {"status": "ok"}

@app.delete("/admin/code/{code_id}", dependencies=[Depends(admin_auth)])
def admin_delete(code_id: int):
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("DELETE FROM activation_codes WHERE id=?", (code_id,))
    conn.commit()
    conn.close()
    return {"status": "deleted"}

# ---------- Admin Panel ----------
@app.get("/admin/panel", response_class=HTMLResponse)
def admin_panel():
    return Path("admin.html").read_text(encoding="utf-8")